# ================================
# STAGE: QUALITY GATE
# ================================

quality-gate:
  stage: quality-gate
  image: python:3.9
  dependencies:
    - lint:pylint
    - coverage:full
    - security:semgrep
  tags:
    - code-quality
    - static-analysis
  
  script:
    - |
      set +x
      echo "=== COMPREHENSIVE QUALITY GATE VALIDATION ==="
      
      # Check if required files exist
      if [ ! -f "reports/coverage/coverage.json" ]; then
        echo "ERROR: Coverage report not found"
        exit 1
      fi
      
      if [ ! -f "reports/pylint/pylint-report.txt" ]; then 
        echo "ERROR: Pylint report not found"
        exit 1
      fi
      
      if [ ! -f "reports/security/summary.json" ]; then
        echo "ERROR: Security report not found"
        exit 1
      fi
      
      # Extract metrics
      COVERAGE=$(python -c "import json; data=json.load(open('reports/coverage/coverage.json')); print(data['totals']['percent_covered'])")
      PYLINT_SCORE=$(cat reports/pylint/pylint-report.txt | grep "Your code has been rated" | cut -d' ' -f7 | cut -d'/' -f1)
      SECURITY_CRITICAL=$(python -c "import json; data=json.load(open('reports/security/summary.json')); print(data['critical_count'])")
      SECURITY_HIGH=$(python -c "import json; data=json.load(open('reports/security/summary.json')); print(data['high_count'])")
      SECURITY_TOTAL=$(python -c "import json; data=json.load(open('reports/security/summary.json')); print(data['total_findings'])")
      
      echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
      echo "â”‚            QUALITY METRICS              â”‚"
      echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
      echo "â”‚ Coverage:     $COVERAGE%                   â”‚"
      echo "â”‚ Pylint:       $PYLINT_SCORE/10                â”‚"
      echo "â”‚ Sec Critical: $SECURITY_CRITICAL                   â”‚"
      echo "â”‚ Sec High:     $SECURITY_HIGH                   â”‚"
      echo "â”‚ Sec Total:    $SECURITY_TOTAL                  â”‚"
      echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
      
      # Validate thresholds
      QUALITY_GATE_PASSED=true
      
      # Coverage check
      if (( $(echo "$COVERAGE < $COVERAGE_THRESHOLD" | bc -l) )); then
        echo "FAILED: Coverage below threshold: $COVERAGE% < $COVERAGE_THRESHOLD%"
        QUALITY_GATE_PASSED=false
      else
        echo "PASSED: Coverage above threshold: $COVERAGE% >= $COVERAGE_THRESHOLD%"
      fi
      
      # Pylint check
      if (( $(echo "$PYLINT_SCORE < $PYLINT_THRESHOLD" | bc -l) )); then
        echo "FAILED: Pylint score below threshold: $PYLINT_SCORE < $PYLINT_THRESHOLD"
        QUALITY_GATE_PASSED=false
      else
        echo "PASSED: Pylint score above threshold: $PYLINT_SCORE >= $PYLINT_THRESHOLD"
      fi
      
      # Security checks
      if [ "$SECURITY_CRITICAL" -gt "$SEMGREP_MAX_CRITICAL" ]; then
        echo "FAILED: Critical security vulnerabilities found: $SECURITY_CRITICAL > $SEMGREP_MAX_CRITICAL"
        QUALITY_GATE_PASSED=false
      else
        echo "PASSED: No critical security vulnerabilities"
      fi
      
      if [ "$SECURITY_HIGH" -gt "$SEMGREP_MAX_HIGH" ]; then
        echo "FAILED: Too many high severity security issues: $SECURITY_HIGH > $SEMGREP_MAX_HIGH"
        QUALITY_GATE_PASSED=false
      else
        echo "PASSED: High severity security issues within threshold: $SECURITY_HIGH <= $SEMGREP_MAX_HIGH"
      fi
      
      # Final decision
      if [ "$QUALITY_GATE_PASSED" = false ]; then
        echo ""
        echo "ğŸš¨ QUALITY GATE FAILED - Merge blocked"
        echo "Fix the issues above before proceeding"
        exit 1
      else
        echo ""
        echo "ğŸ‰ QUALITY GATE PASSED - Ready to merge"
        echo "All quality and security checks passed!"
      fi
      
      # Generate comprehensive quality reports 
      mkdir -p reports/quality-gate
      cat > reports/quality-gate/summary.json << EOF
      {
        "overall_passed": $QUALITY_GATE_PASSED,
        "metrics": {
          "coverage": $COVERAGE,
          "pylint_score": $PYLINT_SCORE,
          "security_critical": $SECURITY_CRITICAL,
          "security_high": $SECURITY_HIGH,
          "security_total": $SECURITY_TOTAL
        },
        "thresholds": {
          "coverage_threshold": $COVERAGE_THRESHOLD,
          "pylint_threshold": $PYLINT_THRESHOLD,
          "security_max_critical": $SEMGREP_MAX_CRITICAL,
          "security_max_high": $SEMGREP_MAX_HIGH,
          "security_max_medium": $SEMGREP_MAX_MEDIUM
        },
        "timestamp": "$(date -Iseconds)"
      }
      EOF
      
  artifacts:
    when: always
    paths:
      - reports/quality-gate/
    expire_in: 1 week
  allow_failure: false
