# ================================
# STAGE: TEST
# ================================

test:python_syntax:
  stage: test
  script:
    - echo 'Starting Python syntax and compilation tests...'
    - echo -e 'Python version'
    - python3 --version
    - echo 'Pip version'
    - pip3 --version
    
    # Test Container 1 (log_processor)
    - echo 'Testing log_processor Python syntax...'
    - python3 -m py_compile src/local/log_processor/app.py
    - echo 'log_processor/app.py syntax OK'
    
    # Test Container 2 (log_collector)  
    - echo 'Testing log_collector Python syntax...'
    - python3 -m py_compile src/remote/log_collector/app.py
    - echo 'âœ“ log_collector/app.py syntax OK'
    
    # Create virtual environment for testing dependencies
    - echo 'Creating virtual environment...'
    - python3 -m venv test_venv
    - source test_venv/bin/activate
    
    # Install dependencies and test imports for log_processor
    - echo 'Installing dependencies for log_processor...'
    - cd src/local/log_processor
    - pip install -r requirements.txt
    - python3 -c "import time, logging, datetime; print('log_processor imports OK')"
    - cd ../../
    
    # Install dependencies and test imports for log_collector
    - echo 'Installing dependencies for log_collector...'
    - cd src/remote/log_collector  
    - pip install -r requirements.txt
    - python3 -c "import time, logging, datetime, os; print('log_collector imports OK')"
    - cd ../../
    
    # Test if scripts can run for a few seconds
    - echo 'Testing if scripts can execute...'
    - timeout 5 python3 src/local/log_processor/app.py || echo 'log_processor runs (timeout expected)'
    - timeout 5 python3 src/remote/log_collector/app.py || echo 'log_collector runs (timeout expected)'
    
    # Cleanup
    - deactivate || true
    - rm -rf test_venv

test:unit:
  stage: test
  image: python:3.9
  tags:
    - code-quality
    - static-analysis
  before_script:
    - python -m pip install --upgrade pip
    - pip install -r requirements.txt
    - rm -rf .pylint_cache || true
  script:
    - mkdir -p reports/tests
    - pytest tests/unit/ -m "unit" --verbose --junitxml=reports/tests/unit-junit.xml
  artifacts:
    when: always
    paths:
      - reports/tests/
    reports:
      junit: reports/tests/unit-junit.xml
    expire_in: 1 week
  allow_failure: false

test:integration:
  stage: test
  image: python:3.9
  tags:
    - code-quality
    - static-analysis
  before_script:
    - python -m pip install --upgrade pip
    - pip install -r requirements.txt
    - rm -rf .pylint_cache || true
  script:
    - mkdir -p reports/tests
    - pytest tests/integration/ -m "integration" --verbose --junitxml=reports/tests/integration-junit.xml
  artifacts:
    when: always
    paths:
      - reports/tests/
    reports:
      junit: reports/tests/integration-junit.xml
    expire_in: 1 week
  allow_failure: false

