
# ================================
# STAGE: LINT
# ================================

lint:pylint:
  stage: lint
  image: python:3.9
  tags:
    - code-quality
    - static-analysis
  before_script:
    - python -m pip install --upgrade pip
    - pip install -r requirements.txt
    - rm -rf .pylint_cache || true
  script:
    # Run pylint and generate reports
    - mkdir -p reports/pylint
    - pylint src/local/log_processor/*.py --output-format=text --reports=y > reports/pylint/pylint-report_processor.txt || true
    - pylint src/local/log_processor/*.py --output-format=json > reports/pylint/pylint-report_processor.json || true
    - pylint src/local/log_processor/*.py --output-format=parseable > reports/pylint/pylint-parseable_processor.txt || true    
    
    - pylint src/remote/log_collector/*.py --output-format=text --reports=y > reports/pylint/pylint-report_collector.txt || true
    - pylint src/remote/log_collector/*.py --output-format=json > reports/pylint/pylint-report_collector.json || true
    - pylint src/remote/log_collector/*.py --output-format=parseable > reports/pylint/pylint-parseable_collector.txt || true    
    
    # Show summary in console
    - echo "=== PYLINT SUMMARY ==="
    - tail -n 20 reports/pylint/pylint-report_processor.txt
    - tail -n 20 reports/pylint/pylint-parseable_collector.txt

  
    # Check for critical errors (optional)
    - pylint src/ --fail-under=$PYLINT_THRESHOLD --output-format=text
  artifacts:
    when: always
    paths:
      - reports/pylint
    expire_in: 1 week
  allow_failure: false

lint:python_syntax:
  stage: lint
  image: python:3.9
  tags:
    - code-quality
  script:
    - echo 'Starting Python syntax and compilation tests...'
    - echo 'Python version'
    - python3 --version
    - echo 'pip version'
    - pip3 --version
    
    # Create reports directory
    - mkdir -p reports/syntax
    
    # Test Container 1 (log_processor)
    - echo 'Testing log_processor Python syntax...'
    - python3 -m py_compile src/local/log_processor/app.py 2>&1 | tee reports/syntax/log_processor_syntax.log
    - echo 'log_processor/app.py syntax OK'
    
    # Test Container 2 (log_collector)  
    - echo 'Testing log_collector Python syntax...'
    - python3 -m py_compile src/remote/log_collector/app.py 2>&1 | tee reports/syntax/log_collector_syntax.log
    - echo 'log_collector/app.py syntax OK'
    
    # Create virtual environment for testing dependencies
    - echo 'Creating virtual environment...'
    - python3 -m venv test_venv
    - source test_venv/bin/activate
    
    # Install dependencies and test imports for log_processor
    - echo 'Installing dependencies for log_processor...'
    - cd src/local/log_processor
    - pip install -r requirements.txt 2>&1 | tee ../../../reports/syntax/log_processor_pip_install.log
    - python3 -c "import time, logging, datetime; print('log_processor imports OK')" 2>&1 | tee ../../../reports/syntax/log_processor_imports.log
    - cd ../../../
    
    # Install dependencies and test imports for log_collector
    - echo 'Installing dependencies for log_collector...'
    - cd src/remote/log_collector  
    - pip install -r requirements.txt 2>&1 | tee ../../../reports/syntax/log_collector_pip_install.log
    - python3 -c "import time, logging, datetime, os; print('log_collector imports OK')" 2>&1 | tee ../../../reports/syntax/log_collector_imports.log
    - cd ../../../
    
    # Test if scripts can run for a few seconds
    - echo 'Testing if scripts can execute...'
    - timeout 5 python3 src/local/log_processor/app.py 2>&1 | tee reports/syntax/log_processor_execution.log || echo 'log_processor runs (timeout expected)'
    - timeout 5 python3 src/remote/log_collector/app.py 2>&1 | tee reports/syntax/log_collector_execution.log || echo 'log_collector runs (timeout expected)'
    
    # Create summary report
    - echo "=== SYNTAX CHECK SUMMARY ===" > reports/syntax/summary.txt
    - date >> reports/syntax/summary.txt
    - echo "" >> reports/syntax/summary.txt
    - echo "Files checked:" >> reports/syntax/summary.txt
    - echo "- src/local/log_processor/app.py" >> reports/syntax/summary.txt
    - echo "- src/remote/log_collector/app.py" >> reports/syntax/summary.txt
    - cat reports/syntax/summary.txt
    
    # Cleanup
    - deactivate || true
    - rm -rf test_venv
  
  artifacts:
    when: always
    paths:
      - reports/syntax
    expire_in: 1 week
  
  allow_failure: false