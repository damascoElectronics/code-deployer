
# ================================
# STAGE: CODE QUALITY
# ================================

lint:python_syntax:
  stage: lint
  image: python:3.9
  tags:
    - code-quality
  script:
    - |
      set +x
      echo -e ${BBlue}Python syntax and compilation tests...${NC}
      echo -e ${GREEN}Python version${NC}
      python3 --version
      echo -e ${GREEN}pip version${NC}
      pip3 --version

      # Create reports directory
      mkdir -p reports/syntax
    
      # Test Container 1 (log_processor)
      echo -e ${BBlue}Testing log_processor Python syntax...${NC}
      python3 -m py_compile src/local/log_processor/app.py 2>&1 | tee reports/syntax/log_processor_syntax.log && echo -e ${GREEN}log_processor/app.py syntax ${BIGreen}OK${NC} || ${RED}log_processor/app.py syntax ${BRed}ERROR${NC}
    
      # Test Container 2 (log_collector)  
      echo -e ${BBlue}Testing log_collector Python syntax...${NC}
      python3 -m py_compile src/remote/log_collector/app.py 2>&1 | tee reports/syntax/log_collector_syntax.log && echo -e ${GREEN}log_collector/app.py syntax ${BIGreen}OK${NC} || ${RED}log_collector/app.py syntax ${BRed}ERROR${NC}
    
      # Test Container 2 (ogs_data_generator)  
      echo -e ${BBlue}Testing ogs_data_generator Python syntax...${NC}
      python3 -m py_compile src/remote/ogs_data_generator/app.py 2>&1 | tee reports/syntax/ogs_data_generator.log && echo -e ${GREEN}ogs_data_generator/app.py syntax ${BIGreen}OK${NC} || ${RED}ogs_data_generator/app.py syntax ${BRed}ERROR${NC}
    

      # Create virtual environment for testing dependencies
      echo -e ${BBlue}Creating virtual environment...${NC}
      python3 -m venv test_venv
      source test_venv/bin/activate
    
      # Install dependencies and test imports for log_processor
      echo -e ${BBlue}Installing dependencies for log_processor...${NC}
      cd src/local/log_processor
      pip install -r requirements.txt 2>&1 | tee ../../../reports/syntax/log_processor_pip_install.log
      python3 -c "import time, logging, datetime; print('log_processor imports OK')" 2>&1 | tee ../../../reports/syntax/log_processor_imports.log
      cd ../../../
    
      # Install dependencies and test imports for log_collector
      echo -e ${BBlue}Installing dependencies for log_collector...${NC}
      cd src/remote/log_collector  
      pip install -r requirements.txt 2>&1 | tee ../../../reports/syntax/log_collector_pip_install.log
      python3 -c "import time, logging, datetime, os; print('log_collector imports OK')" 2>&1 | tee ../../../reports/syntax/log_collector_imports.log
      cd ../../../
    
      # Test if scripts can run for a few seconds
      echo -e ${BBlue}Testing if scripts can execute...${NC}
      timeout 5 python3 src/local/log_processor/app.py 2>&1 | tee reports/syntax/log_processor_execution.log || echo -e ${GREEN}log_processor runs, timeout expected${NC}
      timeout 5 python3 src/remote/log_collector/app.py 2>&1 | tee reports/syntax/log_collector_execution.log || echo -e ${BBlue}log_collector runs, timeout expected${NC}
    
      # Create summary report
      
      echo "=== SYNTAX CHECK SUMMARY ===" > reports/syntax/summary.txt
      date >> reports/syntax/summary.txt
      echo "" >> reports/syntax/summary.txt
      echo "Files checked:" >> reports/syntax/summary.txt
      echo "- src/local/log_processor/app.py" >> reports/syntax/summary.txt
      echo "- src/remote/log_collector/app.py" >> reports/syntax/summary.txt
      cat reports/syntax/summary.txt
      echo -e ${BIGreen}SYNTAX CHECK SUMMARY on ${BLUE}summary.txt${NC}
      # Cleanup
      deactivate || true
      rm -rf test_venv
  
  artifacts:
    when: always
    paths:
      - reports/syntax
    expire_in: 1 week
  
  allow_failure: false

lint:pylint:
  stage: lint
  needs: [lint:python_syntax]
  image: python:3.9
  tags:
    - code-quality
    - static-analysis
  before_script:
    - python -m pip install --upgrade pip
    - pip install -r requirements.txt
    - rm -rf .pylint_cache || true
  script:
    # Run pylint and generate reports
    - mkdir -p reports/pylint
    - pylint src/local/log_processor/*.py --output-format=text --reports=y > reports/pylint/pylint-report_processor.txt || true
    - pylint src/local/log_processor/*.py --output-format=parseable > reports/pylint/pylint-parseable_processor.txt || true    
    
    - pylint src/remote/log_collector/*.py --output-format=text --reports=y > reports/pylint/pylint-report_collector.txt || true
    - pylint src/remote/log_collector/*.py --output-format=parseable > reports/pylint/pylint-parseable_collector.txt || true    
    
    - pylint src/remote/ogs_data_generator/*.py --output-format=text --reports=y > reports/pylint/pylint-ogs_data_generator.txt || true
    - pylint src/remote/ogs_data_generator/*.py --output-format=parseable > reports/pylint/pylint-ogs_data_generator.txt || true    
    

    # Show summary in console
    - |
      set +x
      echo -e ${BBlue}=== PYLINT SUMMARY ===${NC}
      echo -e ${BBlue}pylint-report_processor ${NC}
      tail -n 20 reports/pylint/pylint-report_processor.txt
      echo -e ${BBlue}pylint-report_collector ${NC}
      tail -n 20 reports/pylint/pylint-report_collector.txt
      # Check for critical errors (optional)
      echo -e ${BBlue}Check for critical errors  ${NC}
      pylint src/ --fail-under=$PYLINT_THRESHOLD --output-format=text
  artifacts:
    when: always
    paths:
      - reports/pylint
    expire_in: 1 week
  allow_failure: false

