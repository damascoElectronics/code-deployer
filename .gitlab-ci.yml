# stages
stages:
  - lint
  - test
  - build

# Global variables 
variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"

# Cache to speed up builds
cache:
  paths:
    - .cache/pip/
    - venv/

# Job for linting with pylint
lint:pylint:
  stage: lint
  image: python:3.9
  tags:
    - code-quality
    - static-analysis
  before_script:
    - python -m pip install --upgrade pip
    - pip install -r requirements.txt
  script:
    # Run pylint and generate reports
    - mkdir -p reports
    - pylint src/ --ignore=bad_example.py
    - pylint src/ --output-format=text --reports=y > reports/pylint-report.txt || true
    - pylint src/ --output-format=json > reports/pylint-report.json || true
    - pylint src/ --output-format=parseable > reports/pylint-parseable.txt || true
    
    # Generate JUnit report (optional)
    # - pylint src/ --output-format=pylint_junit.JunitReporter > reports/pylint-junit.xml || true
    
    # Show summary in console
    - echo "=== PYLINT SUMMARY ==="
    - tail -n 20 reports/pylint-report.txt
    
    # Check for critical errors (optional)
    - pylint src/ --fail-under=8.0 --output-format=text
  artifacts:
    when: always
    paths:
      - reports/
    expire_in: 1 week
    # reports:
    #  junit: reports/pylint-junit.xml
  allow_failure: false  # Set to true if you don't want the pipeline to fail.

# Alternative job with more settings
lint:pylint-detailed:
  stage: lint
  image: python:3.9
  tags:
    - code-quality
    - static-analysis
  before_script:
    - python -m pip install --upgrade pip
    - pip install -r requirements.txt
  script:
    - mkdir -p reports/pylint
    
    # Analysis by modules
    - find src/ -name "*.py" -exec pylint {} --output-format=json \; > reports/pylint/individual-files.json || true
    
    # Full report
    - pylint src/ --output-format=text --reports=y > reports/pylint/full-report.txt
    
    # Report only errors and warnings
    - pylint src/ --output-format=text --disable=C,R > reports/pylint/errors-warnings.txt || true
    
    # Metrics and statistics
    - pylint src/ --output-format=text --reports=y --msg-template='{path}:{line}:\ [{msg_id}({symbol}), {obj}] {msg}' > reports/pylint/detailed-report.txt
    
    # Check minimum score
    - PYLINT_SCORE=$(pylint src/ --output-format=text | grep "Your code has been rated" | cut -d' ' -f7 | cut -d'/' -f1)
    - echo "Pylint Score:\ $PYLINT_SCORE"
    - python -c "import sys; sys.exit(0 if float('$PYLINT_SCORE') >= 8.0 else 1)"
  artifacts:
    when: always
    paths:
      - reports/pylint/
    expire_in: 1 week
  allow_failure: true

# Job to genenerate HTML report using pylint-html
lint:pylint-html:
  stage: lint
  image: python:3.9
  tags:
    - code-quality
    - static-analysis
  before_script:
    - pip install pylint pylint-html
  script:
    - mkdir -p reports/html
    - pylint src/ --load-plugins=pylint_html --output-format=pylint_html.HTMLReporter > reports/html/pylint-report.html || true
  artifacts:
    when: always
    paths:
      - reports/html/
    expire_in: 1 week
  allow_failure: true

# To integrate reports into Merge Requests, you can use GitLab Page
pages:
  stage: build
  image: python:3.9
  tags:
    - code-quality
    - static-analysis
  dependencies:
    - lint:pylint-html
  script:
    - mkdir public
    - cp -r reports/html/* public/ 2>/dev/null || echo "No HTML reports found"
  artifacts:
    paths:
      - public
  only:
    - main
    - master