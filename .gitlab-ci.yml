# 
stages:          # List of stages for jobs, and their order of execution
  - quality
  - security
#  - build
#  - test
#  - deploy

security_vulnerability_scan:
  stage: security
  image: python:3.9-slim
  tags:
    - security
    - vulnerability-scan
  before_script:
    # Install security scanning tools
    - apt-get update && apt-get install -y curl wget git jq
    - pip install safety pip-audit cyclonedx-bom
    
    # Install Syft for SBOM generation
    - curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin
    
    # Install Grype for vulnerability scanning
    - curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh -s -- -b /usr/local/bin
    
  script:
    - echo "=== Starting Security Vulnerability Assessment ==="
    
    # Generate SBOM for both containers
    - echo "=== Generating Software Bill of Materials (SBOM) ==="
    - cyclonedx-py requirements -i local/log_processor/requirements.txt -o log_processor_sbom.json --format json
    - cyclonedx-py requirements -i remote/log_collector/requirements.txt -o log_collector_sbom.json --format json
    
    # Generate CPE-compatible asset list
    - echo "=== Generating CPE Asset List ==="
    - python scripts/generate_cpe_assets.py
    
    # Python package vulnerability scanning with Safety
    - echo "=== Running Safety vulnerability scan ==="
    - safety check --json --output safety-report.json -r local/log_processor/requirements.txt || true
    - safety check --json --output safety-report-collector.json -r remote/log_collector/requirements.txt || true
    
    # Enhanced vulnerability scanning with pip-audit
    - echo "=== Running pip-audit vulnerability scan ==="
    - pip-audit --format=json --output=pip-audit-processor.json -r local/log_processor/requirements.txt || true
    - pip-audit --format=json --output=pip-audit-collector.json -r remote/log_collector/requirements.txt || true
    
    # Container vulnerability scanning with Grype
    - echo "=== Running container vulnerability scan ==="
    - grype log_processor_sbom.json -o json --file grype-processor-report.json || true
    - grype log_collector_sbom.json -o json --file grype-collector-report.json || true
    
    # Generate comprehensive vulnerability report
    - echo "=== Generating comprehensive vulnerability report ==="
    - python scripts/generate_vulnerability_report.py
    
    # Display summary
    - echo "=== Vulnerability Scan Summary ==="
    - cat vulnerability-summary.json
    
  artifacts:
    reports:
      sast: sast-report.json
    paths:
      - "*_sbom.json"
      - "*-report.json"
      - "vulnerability-summary.json"
      - "cpe-assets.json"
      - "vulnerability-detailed-report.html"
    expire_in: 30 days
  allow_failure: false # Fail pipeline if critical vulnerabilities found

code_quality_analysis:
  stage: quality
  image: python:3.9-slim
  tags:
    - code-quality
  before_script:
    - apt-get update && apt-get install -y git
    - pip install pylint black isort mypy bandit
    - pip install -r local/log_processor/requirements.txt
    - pip install -r remote/log_collector/requirements.txt
  script:
    # Google Style Guide compliance
    - echo "=== Running pylint with Google style ==="
    - pylint --rcfile=.pylintrc local/log_processor/app.py remote/log_collector/app.py || true
    
    # Code formatting check
    - echo "=== Checking code formatting with black ==="
    - black --check --diff local/log_processor/app.py remote/log_collector/app.py || true
    
    # Import sorting
    - echo "=== Checking import sorting ==="
    - isort --check-only --diff local/log_processor/app.py remote/log_collector/app.py || true
    
    # Type checking
    - echo "=== Running type checking ==="
    - mypy local/log_processor/app.py remote/log_collector/app.py || true
    
    # Basic security linting
    - echo "=== Running basic security analysis ==="
    - bandit -r local/log_processor/ remote/log_collector/ -f json -o bandit-report.json || true
    - cat bandit-report.json
  artifacts:
    reports:
      codequality: code-quality-report.json
    paths:
      - bandit-report.json
      - pylint-report.txt
    expire_in: 1 week
  allow_failure: true